<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>å¦é—¨å­¦ç”Ÿå¢™è®¿å®¢å‘¨æŠ¥</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
{% raw %}
:root {
  --bg: #f5f7fb;
  --card: #ffffff;
  --primary: #4f46e5;
  --text: #1f2937;
  --muted: #6b7280;
}

* { box-sizing: border-box; }

body {
  margin: 0;
  padding: 24px;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
               Roboto, Helvetica, Arial, "PingFang SC";
  background: var(--bg);
  color: var(--text);
}

h1 { margin: 0 0 4px; }

.subtitle {
  color: var(--muted);
  margin-bottom: 12px;
  font-size: 14px;
}

.dashboard {
  display: grid;
  grid-template-columns: 1fr;
  gap: 20px;
}

.card {
  background: var(--card);
  border-radius: 14px;
  padding: 20px 24px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.05);
}

.card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
}

.card-header h2 {
  margin: 0;
  font-size: 18px;
}

.controls {
  display: flex;
  align-items: center;
  gap: 8px;
}

.stats {
  display: flex;
  gap: 32px;
}

.stat {
  font-size: 14px;
  color: var(--muted);
}

.stat b {
  display: block;
  font-size: 26px;
  color: var(--text);
}

.chart-box {
  position: relative;
  height: 320px;
}

select, button {
  padding: 6px 10px;
  font-size: 14px;
  border-radius: 8px;
  border: 1px solid #ddd;
  background: #fff;
}

button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

footer {
  text-align: center;
  color: var(--muted);
  font-size: 12px;
  margin-top: 32px;
}

.header {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-bottom: 24px;
}

.logo {
  height: 110px;
}

.week-switch {
  margin-top: 6px;
  display: flex;
  gap: 12px;
  align-items: center;
}

.week-range {
  font-size: 13px;
  color: var(--muted);
}
{% endraw %}
</style>
</head>

<body>

<!-- ===== é¡µé¢å¤´éƒ¨ ===== -->
<div class="header">
  <img src="/static/logo.png" class="logo">
  <div>
    <h1>å¦é—¨å­¦ç”Ÿå¢™ Â· QQ ç©ºé—´è®¿å®¢å‘¨æŠ¥</h1>

    <div class="subtitle">
      å‘¨æ¬¡ï¼š{{ report.week }}<br>
      å‘¨èŒƒå›´ï¼š<span id="weekRange">è®¡ç®—ä¸­â€¦</span><br>
      æœ€è¿‘åˆ·æ–°ï¼š{{ report.generated_at }}
    </div>

    <div class="week-switch">
      <button onclick="switchWeek(-1)">â¬…ï¸ ä¸Šä¸€å‘¨</button>
      <span>å½“å‰ï¼š{{ report.week }}</span>
      <button onclick="switchWeek(1)" {% if week_offset == 0 %}disabled{% endif %}>
        ä¸‹ä¸€å‘¨ â¡ï¸
      </button>
    </div>
  </div>
</div>

<div class="dashboard">

  <!-- ===== æ€»è§ˆ ===== -->
  <div class="card">
    <h2>ğŸ“Š æœ¬å‘¨æ€»è§ˆ</h2>
    <div class="stats">
      <div class="stat"><b>{{ report.summary.total_visits }}</b>è®¿é—®æ¬¡æ•°</div>
      <div class="stat"><b>{{ report.summary.unique_visitors }}</b>ç‹¬ç«‹è®¿å®¢</div>
      <div class="stat"><b>{{ report.summary.new_visitors }}</b>æ–°å¢è®¿å®¢</div>
    </div>
  </div>

  <!-- ===== è®¿é—®è¶‹åŠ¿ ===== -->
  <div class="card">
    <div class="card-header">
      <h2 id="trendTitle">è®¿é—®è¶‹åŠ¿</h2>
      <div class="controls">
        <span style="font-size:13px;color:#6b7280;">æ—¶é—´å°ºåº¦</span>
        <select id="scale">
          <option value="86400">æ—¥</option>
          <option value="43200">12å°æ—¶</option>
          <option value="21600">6å°æ—¶</option>
          <option value="10800">3å°æ—¶</option>
          <option value="3600" selected>1å°æ—¶</option>
          <option value="1800">30åˆ†é’Ÿ</option>
          <option value="900">15åˆ†é’Ÿ</option>
        </select>
      </div>
    </div>

    <div class="chart-box">
      <canvas id="totalChart"></canvas>
    </div>
  </div>

</div>

<footer>
  Â© Amoy Campus Confessions 2022â€“2026
</footer>

<script>
/* ================= åç«¯æ³¨å…¥æ•°æ® ================= */
const weekOffset = {{ week_offset }};
const weekStartStr = "{{ report.hourly_168.start }}";
const initialLabels = {{ report.hourly_168.labels | tojson }};
const initialValues = {{ report.hourly_168["values"] | tojson }};

/* ================= å‘¨èŒƒå›´æ˜¾ç¤º ================= */
(function renderWeekRange() {
  const start = new Date(weekStartStr.replace(" ", "T"));
  const end = new Date(start);
  end.setDate(start.getDate() + 6);

  const fmt = d =>
    `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;

  document.getElementById("weekRange").innerText =
    `${fmt(start)} ï½ ${fmt(end)}`;
})();

/* ================= å‘¨åˆ‡æ¢ ================= */
function switchWeek(delta) {
  const target = weekOffset + delta;
  if (target > 0) return;

  const url = new URL(location.href);
  url.searchParams.set("week", target);
  location.href = url.toString();
}

/* ================= æ€»è¶‹åŠ¿å›¾ ================= */
const totalChart = new Chart(
  document.getElementById("totalChart"),
  {
    type: "line",
    data: {
      labels: initialLabels,
      datasets: [
        {
          label: "è®¿é—®æ¬¡æ•°",
          data: initialValues,
          borderWidth: 2,
          pointRadius: 0,
          pointHoverRadius: 4,
          hitRadius: 12,
          tension: 0.35,
          cubicInterpolationMode: "monotone"
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,

      /* ğŸŒŠ æ•´ä½“åŠ¨ç”»æ›´é¡º */
      animation: {
        duration: 700,
        easing: "easeOutCubic"
      },

      /* ğŸ‘‰ æ ¸å¿ƒï¼šä»»æ„ X ä½ç½® hover */
      interaction: {
        mode: "index",
        intersect: false,
        axis: "x"
      },

      plugins: {
        legend: {
          display: false
        },

        tooltip: {
          enabled: true,
          mode: "index",
          intersect: false,
          position: "nearest",

          animation: {
            duration: 200,
            easing: "easeOutQuart"
          },

          callbacks: {
            title(items) {
              // X è½´æ ‡ç­¾
              return items[0].label;
            },
            label(item) {
              return `è®¿é—®æ¬¡æ•°ï¼š${item.formattedValue}`;
            }
          }
        }
      },

      elements: {
        line: {
          tension: 0.35,
          cubicInterpolationMode: "monotone"
        },
        point: {
          radius: 0,
          hitRadius: 12,
          hoverRadius: 4
        }
      },

      scales: {
        x: {
          ticks: {
            autoSkip: true,
            maxRotation: 0
          }
        },
        y: {
          beginAtZero: true
        }
      }
    }
  }
);


/* ================= æ—¶é—´å°ºåº¦åˆ‡æ¢ ================= */
document.getElementById("scale").addEventListener("change", reloadByScale);

function reloadByScale() {
  const scale = document.getElementById("scale").value;

  const start = new Date(weekStartStr.replace(" ", "T")).getTime() / 1000;
  const end = start + 7 * 24 * 3600;

  fetch(`/api/report/custom?start=${start}&end=${end}&scale=${scale}`)
    .then(r => r.json())
    .then(data => {
      totalChart.data.labels = data.series.labels;
      totalChart.data.datasets[0].data = data.series.values;

      totalChart.update({
        duration: 500,
        easing: "easeOutQuart"
      });

      updateTitle(scale);
    })
    .catch(err => console.error("æ—¶é—´å°ºåº¦åˆ·æ–°å¤±è´¥", err));
}

function updateTitle(scale) {
  const map = {
    86400: "æŒ‰æ—¥è®¿é—®è¶‹åŠ¿",
    43200: "12 å°æ—¶è®¿é—®è¶‹åŠ¿",
    21600: "6 å°æ—¶è®¿é—®è¶‹åŠ¿",
    10800: "3 å°æ—¶è®¿é—®è¶‹åŠ¿",
    3600: "1 å°æ—¶è®¿é—®è¶‹åŠ¿",
    1800: "30 åˆ†é’Ÿè®¿é—®è¶‹åŠ¿",
    900: "15 åˆ†é’Ÿè®¿é—®è¶‹åŠ¿"
  };
  document.getElementById("trendTitle").innerText =
    map[scale] || "è®¿é—®è¶‹åŠ¿";
}
</script>

</body>
</html>
